library("xtable")
library("plyr")
library("edgeR")
library("qvalue")
library("QuasiSeq")
library("maps")
library(clinfun)
library("fields")
library("fdrtool")
source('P:/qvalue_1.34.0/qvalue/R/qvalue_m0.R')
source("http://www.public.iastate.edu/~dnett/microarray/multtest.txt")
source("P:/QuasiSeq_Method_CompareFDR_BH_EBP_AHB_m0/hybrid-poisson-test-vc.R")
source("P:/QuasiSeq_Method_CompareFDR_BH_EBP_AHB_m0/Hyprid_poisson_test_vc_modified0.R")
source("P:/QuasiSeq_Method_CompareFDR_BH_EBP_AHB_m0/Hyprid_poisson_test_vc_modified1.R")
source("P:/QuasiSeq_Method_CompareFDR_BH_EBP_AHB_m0/fdrtool_1.2.10/fdrtool/R/ecdf.pval.R")
# source("P:\\stevescode\\QuasiSeq_1.0-2\\QuasiSeq\\R\\QL.fit2.R")
# source("P:\\stevescode\\QuasiSeq_1.0-2\\QuasiSeq\\R\\NBDev.R")
# source("P:\\stevescode\\QuasiSeq_1.0-2\\QuasiSeq\\R\\PoisDev.R")
# source("P:\\stevescode\\QuasiSeq_1.0-2\\QuasiSeq\\R\\QL.results.R")

# pbeta = 1
# "i =  5 ,j =  1 ,k =  1 ,l =  1 ,m =  37"
counts <- structure(c(1534, 34, 19, 3, 25, 9, 244, 118, 42, 32, 1326, 14, 
                      1, 36, 392, 674, 50, 54, 479, 674, 2, 21, 18, 1, 40, 390, 2, 
                      48, 2, 164, 3045, 147, 109, 2, 0, 11, 308, 137, 3, 9, 810, 974, 
                      320, 33, 65, 39, 15, 431, 0, 32, 1150, 6, 24, 407, 2151, 86, 
                      24, 145, 2, 501, 319, 148, 0, 600, 39, 113, 7754, 15, 872, 90, 
                      4, 41794, 3784, 1, 38, 55, 894, 4, 1440, 313, 1, 1329, 75, 1, 
                      19, 6, 645, 565, 3, 10, 2245, 0, 3191, 86, 5, 292, 77, 72, 2, 
                      411, 669, 82, 13, 3, 17, 12, 494, 34, 50, 93, 3898, 14, 0, 57, 
                      673, 7095, 20, 129, 109, 663, 7, 30, 19, 2, 53, 721, 0, 141, 
                      3, 92, 1016, 961, 16, 4, 1, 34, 26, 119, 5, 1, 827, 520, 1128, 
                      36, 22, 601, 9, 127, 7, 21, 186, 27, 2, 4498, 443, 36, 36, 1345, 
                      3, 381, 316, 464, 3, 16709, 19, 163, 2202, 251, 898, 124, 4, 
                      6761, 1464, 0, 19, 262, 1632, 12, 305, 173, 90, 1533, 50, 5, 
                      4, 2, 643, 1079, 3, 4, 1713, 3, 1206, 237, 15, 821, 22, 121, 
                      7, 507, 1511, 85, 27, 1, 19, 11, 180, 27, 24, 31, 661, 8, 1, 
                      11, 109, 1205, 37, 146, 83, 787, 2, 86, 6, 0, 10, 503, 12, 24, 
                      1, 87, 879, 459, 448, 4, 0, 1, 31, 306, 10, 2, 226, 1553, 502, 
                      89, 19, 160, 78, 379, 5, 23, 591, 8, 14, 643, 494, 55, 110, 890, 
                      8, 553, 358, 323, 2, 4240, 18, 126, 4551, 213, 1821, 81, 3, 18415, 
                      1523, 9, 41, 217, 605, 6, 445, 49, 4, 1413, 38, 18, 6, 5, 161, 
                      1824, 0, 4, 1214, 3, 2759, 199, 12, 359, 34, 37, 2, 1237, 5697, 
                      55, 8, 2, 4, 4, 181, 21, 34, 59, 1929, 55, 3, 25, 420, 664, 57, 
                      136, 10, 87, 1, 213, 19, 2, 17, 650, 7, 90, 0, 23, 5281, 925, 
                      98, 0, 3, 4, 80, 143, 6, 0, 787, 1093, 225, 295, 32, 519, 52, 
                      156, 5, 88, 233, 7, 34, 2994, 614, 280, 17, 827, 1, 657, 320, 
                      24, 9, 8273, 35, 78, 2180, 26, 2524, 96, 0, 6384, 3362, 0, 6, 
                      687, 1185, 22, 737, 215, 61, 569, 12, 0, 11, 12, 326, 1069, 1, 
                      17, 2184, 1, 786, 44, 14, 430, 14, 89, 17, 1139, 3303, 204, 35, 
                      4, 24, 7, 737, 19, 33, 71, 2010, 7, 1, 28, 299, 2995, 39, 209, 
                      118, 370, 1, 181, 23, 10, 65, 571, 7, 99, 0, 178, 5835, 330, 
                      187, 1, 0, 17, 102, 509, 10, 1, 727, 2291, 1370, 117, 16, 321, 
                      44, 428, 7, 49, 354, 25, 9, 1390, 1507, 186, 18, 595, 3, 1423, 
                      139, 424, 6, 9824, 40, 109, 2572, 179, 2581, 88, 6, 9718, 3187, 
                      0, 196, 437, 968, 12, 1019, 320, 12, 579, 14, 10, 9, 18, 956, 
                      761, 1, 14, 1599, 7, 6125, 509, 3, 173, 39, 172, 4, 1164, 965, 
                      120, 34, 1, 75, 9, 189, 20, 39, 91, 326, 19, 21, 75, 325, 9329, 
                      57, 153, 142, 165, 7, 86, 10, 3, 31, 1319, 1, 146, 2, 95, 2913, 
                      529, 138, 2, 4, 12, 75, 54, 10, 1, 301, 1529, 556, 17, 39, 478, 
                      149, 276, 5, 59, 714, 28, 14, 1750, 593, 45, 14, 982, 9, 976, 
                      352, 262, 4, 2836, 48, 151, 3679, 174, 5981, 161, 2, 4136, 2051, 
                      17, 45, 195, 863, 5, 64, 258, 37, 744, 54, 11, 23, 10, 194, 163, 
                      4, 31, 434, 0, 2194, 172, 30, 570, 16, 106, 17, 1958, 3698, 31, 
                      35, 1, 32, 9, 371, 66, 106, 78, 1594, 12, 2, 10, 317, 3337, 123, 
                      186, 583, 534, 3, 137, 14, 14, 33, 987, 1, 78, 2, 8, 5597, 146, 
                      364, 0, 0, 10, 152, 263, 17, 3, 255, 2659, 1303, 26, 55, 180, 
                      17, 310, 0, 23, 562, 6, 49, 2230, 643, 61, 57, 384, 8, 1575, 
                      272, 279, 0, 2423, 98, 270, 5610, 122, 2143, 98, 1, 13815, 911, 
                      4, 64, 223, 2008, 9, 343, 259, 10, 982, 37, 3, 3, 6, 515, 2016, 
                      1, 14, 35, 0, 1628, 373, 34, 148, 33, 380, 15, 492, 1582, 63, 
                      28, 2, 16, 7, 149, 64, 11, 20, 1222, 3, 5, 77, 110, 442, 11, 
                      214, 85, 205, 2, 312, 11, 1, 16, 499, 4, 27, 4, 92, 1971, 264, 
                      85, 6, 0, 15, 171, 233, 5, 3, 165, 1317, 601, 126, 6, 151, 36, 
                      170, 7, 17, 170, 1, 17, 2613, 1143, 9, 87, 580, 5, 122, 155, 
                      234, 7, 4874, 2, 103, 11658, 75, 413, 46, 1, 12013, 1107, 2, 
                      28, 433, 791, 21, 682, 91, 14, 1045, 5, 7, 3, 5, 377, 1519, 0, 
                      11, 410, 1, 3744, 91, 12, 109, 39, 17, 0, 257, 2022, 76, 38, 
                      2, 16, 4, 247, 13, 21, 131, 657, 14, 0, 48, 380, 9745, 122, 48, 
                      403, 226, 3, 91, 15, 13, 12, 1147, 0, 23, 1, 12, 2423, 153, 110, 
                      0, 3, 6, 85, 213, 27, 0, 400, 223, 489, 12, 15, 70, 109, 169, 
                      2, 20, 899, 7, 9, 1372, 691, 57, 41, 895, 25, 824, 48, 228, 5, 
                      6879, 32, 110, 4824, 111, 1915, 32, 0, 4726, 931, 3, 31, 1655, 
                      2025, 29, 506, 309, 5, 1063, 18, 2, 15, 12, 577, 648, 1, 6, 631, 
                      2, 2003, 225, 12, 153, 56, 62, 6, 128, 745, 120, 45, 7, 2, 12, 
                      204, 32, 5, 71, 541, 30, 1, 40, 723, 490, 104, 92, 157, 693, 
                      3, 123, 6, 1, 6, 348, 0, 21, 28, 190, 1254, 1154, 86, 0, 3, 4, 
                      332, 89, 6, 4, 357, 3179, 191, 112, 76, 320, 72, 149, 1, 21, 
                      649, 23, 9, 2631, 263, 12, 72, 1792, 1, 472, 210, 516, 1, 1977, 
                      70, 277, 9068, 372, 1020, 73, 0, 28993, 2168, 1, 88, 68, 833, 
                      1, 1881, 330, 2, 1472, 45, 3, 2, 10, 264, 532, 9, 3, 1744, 4, 
                      4331, 15, 3, 459, 177, 92, 2, 202, 691, 164, 7, 0, 7, 17, 86, 
                      23, 29, 28, 1520, 16, 0, 48, 379, 1913, 43, 185, 234, 461, 14, 
                      369, 57, 0, 6, 558, 4, 54, 9, 19, 2424, 358, 302, 1, 2, 21, 313, 
                      17, 5, 0, 40, 1099, 963, 69, 28, 375, 36, 432, 5, 10, 744, 16, 
                      10, 453, 444, 74, 32, 532, 2, 561, 257, 155, 3, 4552, 59, 48, 
                      1660, 386, 855, 243, 0, 20202, 812, 6, 7, 229, 1024, 9, 724, 
                      302, 12, 1001, 34, 7, 13, 8, 986, 287, 2, 2, 1405, 0, 5107, 225, 
                      0, 348, 78, 154, 3, 344, 781, 26, 9, 1, 6, 30, 346, 43, 53, 40, 
                      1675, 34, 0, 69, 350, 650, 50, 178, 209, 914, 19, 253, 13, 13, 
                      24, 162, 0, 114, 8, 73, 3325, 714, 174, 0, 1, 19, 215, 84, 6, 
                      2, 313, 1790, 341, 45, 48, 339, 32, 93, 12, 6, 1515, 28, 16, 
                      1815, 656, 53, 32, 611, 0, 1453, 455, 89, 0, 2128, 31, 68, 4939, 
                      87, 1464, 94, 4, 23877, 2508, 9, 48, 880, 1423, 8, 2424, 295, 
                      15, 155, 66, 8, 5, 9, 980, 753, 3, 3, 1352, 1, 8746, 173, 5, 
                      572, 67, 186, 4, 592, 6454, 143, 38, 1, 52, 26, 426, 56, 103, 
                      93, 1666, 1, 2, 97, 363, 6706, 75, 285, 183, 242, 1, 520, 28, 
                      2, 48, 866, 10, 13, 2, 73, 3369, 528, 67, 3, 1, 5, 135, 248, 
                      9, 1, 695, 1391, 630, 60, 18, 381, 10, 142, 8, 27, 582, 5, 10, 
                      2328, 333, 58, 44, 481, 2, 883, 116, 37, 8, 5994, 177, 102, 5041, 
                      249, 4933, 78, 2, 11913, 1099, 5, 42, 766, 488, 6, 361, 823, 
                      139, 2009, 27, 20, 41, 10, 400, 835, 2, 2, 1138, 5, 1719, 214, 
                      12, 852, 10, 94, 13, 623, 1258, 61, 8, 8, 31, 1, 163, 24, 133, 
                      32, 3706, 21, 0, 17, 115, 2656, 44, 113, 75, 264, 3, 251, 34, 
                      5, 40, 449, 1, 71, 2, 78, 5235, 312, 143, 0, 2, 6, 107, 382, 
                      1, 4, 367, 4073, 1244, 65, 12, 20, 89, 243, 1, 37, 557, 32, 43, 
                      1974, 675, 45, 13, 131, 3, 599, 207, 408, 1, 4948, 80, 125, 4902, 
                      78, 889, 126, 0, 29847, 4946, 4, 43, 123, 1072, 43, 1065, 83, 
                      20, 1257, 9, 14, 11, 9, 501, 1683, 7, 6, 764, 0, 995, 138, 14, 
                      586, 42, 62, 0, 1064, 2200, 98, 83, 0, 12, 15, 52, 76, 20, 65, 
                      317, 33, 1, 135, 563, 425, 44, 58, 1124, 194, 0, 110, 5, 1, 7, 
                      79, 1, 21, 1, 188, 1819, 2029, 55, 0, 0, 1, 335, 12, 4, 0, 115, 
                      1959, 138, 53, 45, 161, 53, 732, 2, 3, 925, 15, 38, 1196, 1806, 
                      26, 36, 574, 10, 338, 863, 340, 22, 912, 46, 163, 11795, 31, 
                      504, 42, 1, 48763, 741, 3, 14, 88, 621, 2, 1802, 37, 1, 3091, 
                      8, 1, 1, 8, 829, 402, 5, 1, 2942, 0, 3288, 34, 2, 141, 100, 55, 
                      2, 202, 1676, 107, 14, 0, 35, 9, 193, 49, 7, 62, 2026, 33, 0, 
                      9, 624, 1306, 33, 110, 129, 173, 2, 268, 30, 6, 24, 354, 7, 35, 
                      2, 41, 3804, 684, 92, 0, 4, 21, 194, 67, 0, 0, 66, 702, 486, 
                      33, 6, 637, 20, 499, 4, 108, 498, 32, 16, 786, 1057, 79, 66, 
                      1243, 25, 293, 476, 734, 9, 2283, 37, 55, 11753, 207, 2745, 50, 
                      8, 27577, 878, 0, 40, 142, 1169, 28, 1991, 52, 22, 1236, 16, 
                      8, 10, 14, 252, 1152, 0, 11, 3889, 6, 4027, 216, 12, 261, 143, 
                      37, 8, 787, 1511, 129, 33, 16, 13, 16, 311, 23, 16, 179, 1628, 
                      3, 1, 74, 133, 2652, 76, 112, 324, 536, 18, 218, 36, 1, 35, 481, 
                      3, 176, 4, 61, 5409, 512, 113, 1, 0, 7, 82, 97, 8, 0, 407, 1150, 
                      416, 52, 25, 677, 81, 511, 5, 36, 158, 1, 13, 5936, 361, 92, 
                      21, 169, 1, 346, 327, 411, 5, 7787, 93, 86, 2524, 44, 869, 58, 
                      0, 12428, 970, 5, 30, 310, 971, 18, 1690, 182, 40, 1270, 64, 
                      5, 2, 14, 323, 291, 1, 28, 1916, 8, 3069, 135, 10, 101, 67, 76, 
                      1, 1379, 4644, 15, 67, 9, 0, 2, 182, 11, 47, 15, 4176, 8, 9, 
                      18, 271, 1111, 26, 150, 75, 135, 3, 182, 23, 0, 97, 385, 0, 140, 
                      0, 25, 3368, 456, 203, 5, 2, 5, 41, 326, 33, 5, 218, 1707, 309, 
                      30, 38, 93, 66, 297, 7, 62, 127, 14, 47, 974, 208, 95, 13, 411, 
                      0, 227, 298, 26, 7, 7799, 139, 55, 2432, 47, 3126, 152, 2, 4382, 
                      563, 9, 77, 208, 780, 29, 823, 106, 18, 620, 214, 8, 20, 15, 
                      207, 722, 0, 3, 1980, 2, 4840, 328, 6, 291, 36, 79, 2, 438, 1996, 
                      76, 21, 0, 25, 9, 125, 13, 17, 21, 2144, 16, 1, 52, 109, 12416, 
                      5, 365, 101, 233, 2, 70, 38, 2, 6, 413, 0, 72, 0, 9, 1935, 668, 
                      168, 0, 2, 16, 31, 107, 11, 3, 250, 2550, 560, 75, 14, 154, 41, 
                      541, 0, 30, 1207, 44, 22, 1418, 843, 53, 48, 692, 2, 560, 73, 
                      308, 2, 5874, 48, 85, 2004, 45, 1909, 48, 0, 9058, 636, 7, 64, 
                      934, 382, 4, 1244, 287, 21, 718, 16, 0, 3, 19, 604, 927, 3, 11, 
                      720, 2, 2329, 487, 1, 134, 1, 30, 1, 79, 564, 41, 19, 0, 60, 
                      26, 326, 49, 19, 69, 902, 9, 3, 21, 417, 2106, 112, 190, 416, 
                      358, 8, 102, 15, 4, 34, 492, 1, 21, 1, 95, 2723, 492, 29, 3, 
                      0, 5, 268, 153, 13, 4, 560, 591, 592, 98, 22, 224, 35, 370, 0, 
                      13, 580, 6, 21, 1356, 518, 50, 13, 605, 3, 925, 807, 287, 11, 
                      3823, 103, 259, 9111, 48, 1912, 75, 0, 8141, 2414, 4, 28, 194, 
                      417, 30, 1343, 165, 37, 1780, 66, 4, 11, 2, 488, 640, 1, 7, 2097, 
                      0, 1074, 252, 9, 581, 34, 61, 1, 385, 1298, 95, 12, 114, 20, 
                      6, 1178, 12, 72, 0, 4174, 13, 31, 11, 168, 63254, 8, 127, 146, 
                      1087, 3, 20, 6, 6, 65, 694, 3, 70, 1, 12, 1030, 108, 128, 0, 
                      7, 0, 62, 180, 7, 1, 356, 2611, 3577, 39, 3, 448, 14, 551, 0, 
                      47, 533, 2, 21, 2860, 92, 118, 26, 322, 0, 298, 164, 307, 0, 
                      3238, 132, 101, 2339, 113, 3045, 224, 0, 5986, 268, 0, 49, 839, 
                      1407, 73, 923, 1001, 43, 852, 26, 5, 13, 4, 318, 1947, 0, 17, 
                      241, 3, 7274, 286, 18, 858, 4, 253, 20, 1216, 305, 182, 13, 16, 
                      8, 16, 393, 10, 112, 2, 1260, 9, 14, 89, 51, 20559, 7, 5, 227, 
                      493, 7, 132, 16, 10, 40, 351, 6, 74, 2, 131, 4025, 1069, 35, 
                      1, 2, 22, 61, 247, 15, 1, 237, 2637, 565, 170, 39, 987, 118, 
                      348, 0, 39, 287, 26, 17, 1305, 1014, 61, 25, 69, 0, 315, 738, 
                      398, 3, 2921, 169, 175, 8694, 153, 1459, 71, 1, 10948, 4155, 
                      2, 41, 231, 1128, 28, 3942, 174, 4, 1182, 32, 8, 6, 1, 521, 1473, 
                      0, 9, 1896, 7, 1856, 188, 6, 454, 25, 113, 2, 473, 1130, 151, 
                      8, 6, 12, 4, 445, 64, 59, 2, 444, 97, 2, 36, 583, 36172, 10, 
                      66, 69, 896, 6, 240, 17, 2, 58, 214, 1, 26, 7, 134, 8340, 306, 
                      232, 2, 0, 30, 206, 225, 15, 3, 437, 3573, 630, 32, 20, 288, 
                      41, 307, 11, 29, 993, 33, 33, 2613, 549, 69, 22, 406, 2, 575, 
                      174, 271, 3, 1596, 4, 100, 9339, 112, 3684, 24, 11, 2791, 1577, 
                      0, 3, 27, 963, 23, 1084, 118, 35, 2198, 195, 0, 0, 15, 229, 790, 
                      17, 3, 514, 1, 3474, 325, 27, 488, 22, 204, 2, 357, 880, 125, 
                      1, 9, 20, 14, 532, 21, 110, 3, 2334, 15, 1, 55, 613, 44782, 2, 
                      36, 87, 438, 3, 155, 54, 3, 60, 1141, 10, 173, 5, 53, 2668, 205, 
                      222, 0, 6, 3, 58, 324, 2, 6, 231, 2189, 99, 58, 22, 321, 40, 
                      283, 1, 32, 740, 9, 39, 1445, 175, 51, 31, 221, 6, 762, 397, 
                      168, 4, 3617, 2, 44, 1878, 160, 5822, 141, 0, 2873, 575, 7, 42, 
                      248, 1953, 20, 908, 144, 46, 738, 46, 8, 12, 19, 556, 1335, 1, 
                      13, 787, 4, 1456, 373, 23, 579, 51, 120, 6, 1522, 372, 78, 5, 
                      14, 2, 18, 213, 106, 118, 4, 840, 23, 17, 68, 142, 30266, 1, 
                      48, 93, 626, 11, 223, 28, 1, 25, 824, 5, 33, 1, 62, 1514, 349, 
                      72, 3, 10, 10, 159, 67, 0, 0, 479, 2714, 1625, 106, 43, 400, 
                      18, 316, 3, 6, 292, 21, 56, 3628, 1557, 67, 10, 970, 0, 516, 
                      228, 261, 1, 13358, 58, 210, 7310, 373, 1192, 31, 4, 15209, 907, 
                      2, 75, 261, 1610, 20, 1929, 369, 2, 586, 37, 17, 0, 37, 1123, 
                      1769, 7, 5, 626, 1, 2038, 251, 16, 419, 16, 291, 20, 897, 1122, 
                      171, 20, 14, 9, 58, 235, 20, 142, 3, 272, 137, 7, 232, 323, 28535, 
                      5, 14, 113, 184, 7, 266, 18, 0, 30, 497, 1, 112, 9, 0, 1378, 
                      274, 237, 2, 1, 16, 193, 79, 2, 0, 166, 1539, 1505, 25, 29, 276, 
                      8, 226, 7, 9, 208, 26, 27, 768, 3263, 72, 34, 267, 1, 543, 261, 
                      149, 2, 1973, 41, 55, 3080, 19, 764, 16, 0, 6014, 1348, 0, 35, 
                      145, 707, 6, 886, 131, 12, 1801, 78, 6, 2, 1, 637, 253, 1, 4, 
                      2977, 4, 4084, 294, 5, 83, 87, 25, 8, 153, 134, 259, 13, 23, 
                      1, 11, 707, 127, 42, 3, 687, 87, 4, 104, 248, 15923, 8, 2, 174, 
                      1517, 6, 243, 15, 5, 146, 573, 7, 28, 0, 92, 1902, 909, 74, 0, 
                      0, 6, 419, 81, 19, 2, 951, 1849, 1635, 15, 21, 827, 114, 469, 
                      0, 28, 1218, 8, 68, 1747, 1220, 61, 37, 268, 4, 346, 252, 248, 
                      4, 2859, 55, 213, 3523, 176, 4528, 39, 2, 12277, 1634, 2, 39, 
                      182, 180, 34, 1629, 229, 18, 694, 106, 5, 2, 14, 439, 1556, 2, 
                      7, 1531, 1, 5382, 75, 16, 342, 25, 211, 6, 792, 1001, 127, 12, 
                      43, 16, 15, 1066, 6, 21, 5, 3823, 8, 3, 23, 177, 312262, 0, 628, 
                      114, 970, 21, 119, 27, 1, 100, 1512, 5, 112, 3, 24, 4186, 79, 
                      383, 10, 10, 7, 18, 441, 19, 1, 67, 2611, 4809, 36, 20, 482, 
                      71, 273, 1, 47, 839, 92, 20, 3411, 338, 233, 21, 353, 7, 1586, 
                      112, 203, 2, 8503, 235, 156, 539, 28, 7956, 314, 8, 4319, 50, 
                      30, 221, 1108, 1925, 32, 629, 292, 120, 1197, 98, 3, 8, 10, 294, 
                      2793, 0, 10, 511, 0, 3246, 1368, 23, 1432, 11, 182, 15, 624, 
                      484, 69, 8, 6, 31, 13, 225, 154, 158, 0, 2829, 62, 16, 30, 155, 
                      3855, 2, 40, 43, 130, 8, 201, 78, 3, 98, 1029, 5, 99, 5, 21, 
                      2743, 205, 232, 3, 1, 13, 66, 371, 72, 6, 338, 3474, 628, 38, 
                      10, 554, 55, 612, 2, 69, 115, 14, 2, 5282, 86, 41, 49, 1277, 
                      1, 1221, 221, 108, 3, 9969, 58, 145, 3508, 187, 5867, 180, 6, 
                      4437, 581, 2, 88, 338, 1143, 26, 719, 370, 6, 972, 54, 0, 8, 
                      5, 558, 1910, 1, 8, 557, 5, 3084, 177, 12, 967, 8, 63, 2, 1771, 
                      816, 229, 24, 25, 13, 11, 78, 148, 78, 0, 1458, 130, 3, 263, 
                      690, 23540, 0, 28, 20, 359, 0, 83, 7, 2, 27, 494, 3, 121, 0, 
                      216, 1866, 1226, 67, 0, 0, 9, 312, 289, 4, 0, 750, 1250, 513, 
                      276, 18, 130, 21, 391, 2, 10, 541, 37, 9, 1800, 575, 77, 7, 557, 
                      8, 1902, 127, 246, 5, 4018, 46, 292, 1614, 38, 3140, 99, 2, 11178, 
                      1699, 0, 51, 747, 816, 10, 1028, 285, 4, 974, 87, 1, 5, 9, 462, 
                      506, 3, 0, 1160, 8, 6920, 220, 6, 311, 13, 166, 19, 429, 723, 
                      260, 52, 4, 15, 32, 1241, 99, 6, 1, 1559, 4, 12, 14, 530, 6281, 
                      9, 41, 157, 851, 1, 234, 39, 0, 22, 1067, 1, 96, 5, 43, 1385, 
                      469, 194, 5, 7, 9, 89, 187, 20, 0, 178, 2485, 534, 149, 24, 393, 
                      15, 237, 2, 19, 783, 22, 91, 3966, 1053, 78, 35, 814, 2, 282, 
                      189, 351, 12, 5512, 49, 302, 4164, 116, 2566, 235, 15, 4606, 
                      757, 1, 155, 919, 1920, 5, 997, 703, 6, 927, 64, 4, 1, 5, 706, 
                      1087, 9, 16, 1995, 2, 4035, 673, 15, 236, 31, 57, 4, 300, 775, 
                      58, 28, 4, 12, 6, 335, 45, 25, 0, 134, 11, 1, 21, 1581, 36738, 
                      10, 21, 95, 727, 2, 125, 30, 3, 11, 1128, 1, 60, 2, 21, 1055, 
                      355, 15, 2, 0, 21, 171, 320, 9, 0, 305, 1078, 554, 119, 4, 156, 
                      38, 364, 1, 10, 307, 6, 16, 1303, 351, 29, 1, 996, 2, 139, 591, 
                      330, 0, 9948, 60, 138, 1958, 159, 1679, 77, 0, 9773, 120, 1, 
                      7, 440, 692, 5, 884, 500, 1, 1206, 20, 8, 8, 37, 95, 195, 0, 
                      5, 812, 3, 4132, 154, 3, 459, 69, 59, 2, 319, 257, 133, 11, 2, 
                      9, 17, 327, 35, 39, 0, 936, 69, 5, 116, 171, 16771, 14, 18, 285, 
                      560, 11, 435, 12, 1, 32, 66, 2, 46, 2, 132, 693, 217, 106, 1, 
                      2, 33, 130, 114, 2, 0, 122, 2012, 118, 60, 0, 285, 52, 117, 5, 
                      6, 358, 6, 7, 293, 868, 68, 56, 88, 2, 249, 83, 138, 3, 1491, 
                      57, 24, 6871, 108, 868, 65, 1, 24606, 485, 2, 19, 382, 221, 18, 
                      1681, 52, 48, 609, 66, 3, 10, 6, 728, 301, 0, 13, 2040, 0, 10327, 
                      175, 6, 185, 34, 51, 4, 70, 981, 58, 7, 19, 2, 4, 1348, 86, 76, 
                      1, 1915, 9, 11, 28, 589, 12170, 2, 48, 120, 1050, 1, 309, 122, 
                      2, 44, 1286, 5, 89, 2, 82, 7983, 638, 124, 0, 3, 5, 89, 153, 
                      17, 9, 250, 1822, 1977, 75, 30, 120, 40, 102, 1, 57, 310, 26, 
                      18, 2104, 134, 93, 22, 947, 0, 276, 441, 115, 3, 24041, 58, 493, 
                      1003, 218, 2237, 284, 2, 3827, 1219, 1, 99, 105, 99, 6, 363, 
                      67, 11, 1829, 58, 3, 7, 13, 342, 1400, 0, 0, 1068, 2, 2510, 466, 
                      0, 1098, 11, 217, 4, 668, 551, 142, 21, 121, 33, 12, 480, 14, 
                      203, 3, 1167, 59, 32, 58, 463, 3295, 5, 10, 90, 860, 6, 190, 
                      16, 2, 20, 251, 3, 73, 0, 23, 3097, 234, 294, 2, 0, 15, 48, 117, 
                      11, 4, 204, 1031, 150, 322, 12, 451, 97, 201, 4, 96, 1105, 43, 
                      17, 1851, 1481, 258, 31, 532, 7, 1786, 150, 641, 5, 1815, 19, 
                      369, 3967, 105, 1194, 110, 4, 20879, 1092, 0, 58, 162, 381, 37, 
                      661, 343, 26, 1066, 9, 9, 4, 3, 685, 418, 1, 8, 1527, 1, 3119, 
                      350, 18, 447, 38, 53, 7, 412, 65, 315, 9, 11, 2, 35, 107, 54, 
                      13, 2, 175, 104, 13, 23, 540, 2891, 4, 18, 170, 909, 0, 360, 
                      10, 7, 12, 163, 2, 18, 5, 188, 1690, 3477, 134, 1, 1, 10, 30, 
                      212, 0, 6, 334, 1101, 289, 75, 16, 213, 24, 402, 18, 23, 716, 
                      9, 8, 421, 3239, 12, 12, 111, 1, 528, 590, 227, 1, 1199, 2, 116, 
                      2810, 83, 828, 38, 0, 11513, 2094, 1, 12, 186, 721, 6, 1253, 
                      145, 1, 792, 26, 4, 0, 2, 891, 386, 9, 8, 1274, 0, 744, 38, 3, 
                      107, 100, 42, 2, 421, 1243, 346, 50, 8, 11, 15, 496, 113, 65, 
                      4, 922, 44, 6, 53, 953, 13188, 5, 15, 94, 22, 16, 141, 34, 0, 
                      35, 173, 0, 114, 1, 56, 1877, 532, 92, 0, 1, 2, 292, 375, 11, 
                      1, 311, 2010, 517, 85, 9, 249, 27, 463, 6, 29, 425, 10, 23, 993, 
                      455, 127, 10, 653, 7, 979, 553, 85, 17, 7442, 6, 338, 14367, 
                      227, 2243, 128, 2, 31808, 796, 2, 22, 340, 250, 5, 601, 236, 
                      6, 162, 28, 0, 8, 7, 337, 639, 6, 9, 436, 2, 928, 212, 3, 764, 
                      46, 28, 1, 659, 671, 231, 12, 46, 11, 14, 408, 73, 40, 4, 563, 
                      71, 5, 58, 291, 23719, 11, 51, 201, 382, 2, 45, 12, 4, 51, 112, 
                      6, 20, 10, 45, 3726, 818, 270, 0, 0, 32, 198, 225, 3, 8, 323, 
                      1600, 495, 110, 30, 376, 133, 200, 1, 15, 678, 23, 41, 979, 532, 
                      166, 114, 1168, 8, 1011, 962, 201, 4, 5909, 22, 119, 11526, 449, 
                      1522, 88, 2, 27228, 1349, 1, 12, 190, 1474, 2, 1218, 138, 13, 
                      2339, 27, 3, 6, 13, 297, 1066, 2, 13, 857, 7, 6061, 155, 19, 
                      793, 15, 85, 9, 164, 940, 127, 20, 6, 33, 3, 1172, 76, 66, 0, 
                      980, 52, 10, 179, 451, 55285, 6, 12, 81, 543, 6, 80, 53, 3, 58, 
                      354, 3, 23, 2, 68, 5744, 240, 105, 13, 1, 3, 157, 207, 13, 2, 
                      817, 338, 336, 37, 13, 414, 61, 262, 2, 62, 450, 15, 3, 2661, 
                      2392, 287, 71, 184, 6, 1517, 233, 345, 5, 677, 60, 115, 7809, 
                      120, 802, 115, 0, 23796, 661, 2, 18, 345, 954, 10, 2008, 438, 
                      12, 411, 22, 5, 5, 4, 583, 269, 8, 3, 1742, 6, 8467, 256, 1, 
                      768, 71, 36, 5, 1223, 1241, 76, 28, 25, 19, 6, 1241, 90, 96, 
                      1, 366, 52, 8, 123, 36, 10636, 8, 23, 83, 1109, 0, 122, 43, 3, 
                      29, 510, 1, 36, 9, 174, 4623, 1140, 203, 2, 0, 14, 385, 110, 
                      41, 0, 304, 4247, 865, 149, 35, 954, 85, 914, 2, 26, 458, 8, 
                      61, 541, 1570, 211, 92, 308, 5, 1540, 367, 180, 6, 12348, 41, 
                      166, 5742, 292, 1351, 261, 0, 41689, 2157, 3, 34, 253, 1122, 
                      11, 1103, 215, 10, 2746, 30, 2, 0, 1, 525, 506, 2, 1, 647, 0, 
                      3567, 989, 4, 281, 45, 84, 5, 635), .Dim = c(100L, 40L))
counts1 <- rbind(counts, rnbinom(2*K, mu = 3, size = 0.3))
?rnbinom
x <- structure(c(0.877745806444357, -2.32730536352858, -0.603178350698587, 
                 0.487738514314729, -0.357744754434484, -0.176529812641517, -0.210393588308522, 
                 -1.32991217880947, -0.569141028594718, -0.188660676657094, -0.894699132304728, 
                 0.493730995935455, -0.78466200213516, 0.0331323430617771, 0.560552248693137, 
                 -2.86368732446282, -0.137678724445275, -0.674681567730469, 1.36384622002154, 
                 0.323009734873493, 0.25180769548322, -0.373976391914496, 0.249807086412334, 
                 0.0816259681106865, -0.634169952552705, 0.558443689377339, 0.00692692129482934, 
                 -0.892713350856608, 2.71992525758881, 0.211279206231718, 0.592637164793275, 
                 1.87215261458716, 0.0407098712614694, -0.12796643432474, -1.53788433793008, 
                 0.109367352165971, -0.529272627751911, 0.201162306077258, 0.503558555168266, 
                 0.248841899013261), .Dim = c(2L, 20L))
K <- 20

design.list <- vector("list",2)
design.list[[1]] <- model.matrix(~rep(c(1,2), each = K))
design.list[[2]] <- rep(1, ncol(counts))
size <- apply(counts[,], 2, quantile, .75)
log.offset <- log(size)
fit <- QL.fit(counts[,], design.list, 
              log.offset = log.offset, 
              Model = "NegBin",
              print.progress=FALSE)

result.fit <- QL.results(fit, Plot=FALSE)


design <- design.list[[1]]
dim(design)



d<-DGEList(counts = counts, group = design[,2],lib.size=exp(log.offset))
d <- calcNormFactors(d)
d
nb.disp<-estimateGLMTrendedDisp(d, design)$trended.dispersion

d$samples$norm.factors
is.integer(d$samples$lib.size)
?is.integer
#####################################
size <- apply(counts1, 2, quantile, .75)


fit <- QL.fit(counts1, design.list, 
              log.offset = log(size), 
              Model = "NegBin",
              print.progress=FALSE)

result.fit <- QL.results(fit, Plot=FALSE)
dim(counts)
log.offset <- log(size)
design <- design.list[[1]]
dim(design)
d<-DGEList(counts = counts, group = design[,2],lib.size=exp(log.offset))
d <- calcNormFactors(d)
str(d)
# d$dispersions
# ?calcNormFactors
# out.d <- estimateGLMTrendedDisp(d, design)
# str(out.d$trended.dispersion)
# 
# nb.disp<-estimateGLMTrendedDisp(d, design)$trended.dispersion
# traceback()
# aveLogCPM(d)
# lib.size <- d$samples$lib.size
# lib.size <- lib.size*d$samples$norm.factors
# aveLogCPM(d$counts,lib.size=lib.size)
# traceback()
# y <- d$counts
# aveLogCPM <- function(y,lib.size=NULL,prior.count=2,dispersion=0.05, ...)
#   #  log2(AveCPM)
#   #  Gordon Smyth
#   #	25 Aug 2012. Last modified 11 March 2012.
# {
#   y <- as.matrix(y)
#   if(is.null(lib.size)) lib.size <- colSums(y)
#   prior.count.scaled <- lib.size/mean(lib.size) * prior.count
#   offset <- log(lib.size+2*prior.count.scaled)
#   abundance <- mglmOneGroup(t(t(y)+prior.count.scaled),dispersion=dispersion,offset=offset)
#   (abundance+log(1e6)) / log(2)
# }

###############
object <- d
if (is(object, "DGEList")) {
  x <- as.matrix(object$counts)
  lib.size <- object$samples$lib.size
}else{
  x <- as.matrix(object)
  lib.size <- colSums(x)
}
all(x==counts)
method <- match.arg(method)
allzero <- rowSums(x > 0) == 0
if (any(allzero)) 
  x <- x[!allzero, , drop = FALSE]
if (nrow(x) == 0 || ncol(x) == 1) 
  method = "none"
#any(allzero)
refColumn <- NULL
logratioTrim = 0.3; sumTrim = 0.05; 
doWeighting = TRUE; Acutoff = -1e+10; p = 0.75
#x <- counts
# dim(counts)
f75 <- .calcFactorQuantile(data=x, lib.size=lib.size, p=0.75)
if( is.null(refColumn) )
  refColumn <- which.min(abs(f75-mean(f75)))

if(length(refColumn)==0 | refColumn < 1 | refColumn > ncol(x)) refColumn <- 1
#refColumn

logratioTrim=.3; sumTrim=0.05; doWeighting=TRUE; Acutoff=-1e10; p=0.75
f <- rep(NA,ncol(x))


for(i in 1:ncol(x))
  f[i] <- .calcFactorWeighted(obs=x[,i],ref=x[,refColumn], libsize.obs=lib.size[i], 
                              libsize.ref=lib.size[refColumn],
                              logratioTrim=logratioTrim, sumTrim=sumTrim, 
                              doWeighting=doWeighting, Acutoff=Acutoff)

x[,i]
f[i]
f
f <- f/exp(mean(log(f)))
f
# i = 36 
################

.calcFactorRLE <- function (data)
{
  gm <- exp(rowMeans(log(data)))
  apply(data, 2, function(u) median((u/gm)[gm > 0]))
}

######
data <- x
lib.size 
size
######
.calcFactorQuantile <- function (data, lib.size, p=0.75)
{
  #	i <- apply(data<=0,1,all)
  #	if(any(i)) data <- data[!i,,drop=FALSE]
  y <- t(t(data)/lib.size)
  f <- apply(y,2,function(x) quantile(x,p=p))
  #	f/exp(mean(log(f)))
}
#############
i <- 1
obs=x[,i];ref=x[,refColumn]; libsize.obs=lib.size[i]; 
libsize.ref=lib.size[refColumn];
logratioTrim=logratioTrim; sumTrim=sumTrim;
doWeighting=doWeighting; Acutoff=Acutoff;
##############
.calcFactorWeighted <- function(obs, ref, libsize.obs=NULL, 
                                libsize.ref=NULL, logratioTrim=.3, 
                                sumTrim=0.05, doWeighting=TRUE, 
                                Acutoff=-1e10)
{
  if( all(obs==ref) ) return(1)
  
  obs <- as.numeric(obs)
  ref <- as.numeric(ref)
  
  if( is.null(libsize.obs) ) nO <- sum(obs) else nO <- libsize.obs
  if( is.null(libsize.ref) ) nR <- sum(ref) else nR <- libsize.ref
  
  logR <- log2((obs/nO)/(ref/nR))			# log ratio of expression, accounting for library size
  absE <- (log2(obs/nO) + log2(ref/nR))/2	# absolute expression
  v <- (nO-obs)/nO/obs + (nR-ref)/nR/ref	 # estimated asymptotic variance
  
  #	remove infinite values, cutoff based on A
  fin <- is.finite(logR) & is.finite(absE) & (absE > Acutoff)
  
  logR <- logR[fin]
  absE <- absE[fin]
  v <- v[fin]
  
  #	taken from the original mean() function
  n <- sum(fin)
  loL <- floor(n * logratioTrim) + 1
  hiL <- n + 1 - loL
  loS <- floor(n * sumTrim) + 1
  hiS <- n + 1 - loS
  
  #	keep <- (rank(logR) %in% loL:hiL) & (rank(absE) %in% loS:hiS)
  #	a fix from leonardo ivan almonacid cardenas, since rank() can return
  #	non-integer values when there are a lot of ties
  keep <- (rank(logR)>=loL & rank(logR)<=hiL) & (rank(absE)>=loS & rank(absE)<=hiS)
  
  if(doWeighting)
    2^( sum(logR[keep]/v[keep], na.rm=TRUE) / sum(1/v[keep], na.rm=TRUE) )
  else
    2^( mean(logR[keep], na.rm=TRUE) )
}
2^1023
.Machine